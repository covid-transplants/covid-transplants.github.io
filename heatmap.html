
<!DOCTYPE html>
<html>
    <head>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-KB759XK5CF"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'G-KB759XK5CF');
	</script>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

        <!-- https://github.com/seiyria/bootstrap-slider
             https://seiyria.com/bootstrap-slider/#example-1 -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">

        <link rel="stylesheet" type="text/css" href="/static/custom.css" id="css_main_file">
        <link rel="stylesheet" type="text/css" href="/static/radio-button.css">

        <!-- sophisticated select box with hierarchy features -->
        <link rel="stylesheet" href="/static/hierarchy-select/dist/hierarchy-select.min.css">

        
        

        <style>
            
            
        </style>
    </head>

    <body>
        <!-- Navigation Bar -->
        <nav class="navbar sticky-top navbar-expand-lg navbar-dark bg-light">
            <a class="navbar-brand"
               href="/">
                Organ transplantation during COVID-19
            </a>

            <button id="navbar_style1_menu_btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item ">
                        <a class="nav-link" href="/">
                            <svg class="bi" width="22" height="22" fill="currentColor">
                                <use xlink:href="/static/bootstrap-icons.svg#bar-chart-line"/>
                            </svg>
                            &nbsp;
                            Graphs
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/heatmap.html">
                            <svg class="bi" width="22" height="22" fill="currentColor">
                                <use xlink:href="/static//bootstrap-icons.svg#globe2"/>
                            </svg>
                            &nbsp;
                            Heatmaps
                        </a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="/collaborators.html">
                            <svg class="bi" width="22" height="22" fill="currentColor">
                                <use xlink:href="/static//bootstrap-icons.svg#people-fill"/>
                            </svg>
                            &nbsp;
                            Collaborators
                        </a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="/media.html">
                            <svg class="bi" width="22" height="22" fill="currentColor">
                                <use xlink:href="/static/bootstrap-icons.svg#bookmarks-fill"/>
                            </svg>
                            &nbsp;
                            Media
                        </a>
                    </li>
                    <li class="nav-item ">
                        <a class="nav-link" href="/about.html">
                            <svg class="bi" width="22" height="22" fill="currentColor">
                                <use xlink:href="/static//bootstrap-icons.svg#info-circle"/>
                            </svg>
                            &nbsp;
                            About
                        </a>
                    </li>
                </ul>
            </div>

            <!-- A developer helper tool - showing which bootstrap screen width is active: xs/sm/md/lg/xl -->
            <!-- https://getbootstrap.com/docs/4.0/utilities/display/#hiding-elements -->
            <!--
            <div>
                <div class='d-block d-sm-none'>XS</div>
                <div class='d-none d-sm-block d-md-none'>SM</div>
                <div class='d-none d-md-block d-lg-none'>MD</div>
                <div class='d-none d-lg-block d-xl-none'>LG</div>
                <div class='d-none d-xl-block'>XL</div>
            </div>
            -->
        </nav>

        <div class="mt-3 container-fluid">
            
<style>
#map {
    color: white;
}
.border {
    stroke-width: .3px;
    fill: none;
    stroke: #333;
 }
.caption {
    font-weight: bold;
}

.key path {
    display: none;
}

.key line {
    stroke: #000;
    shape-rendering: crispEdges;
 }

path {
  fill: #ccc;
  stroke: #fff;
  stroke-width: .5px;
}

path:hover {
  fill: red;
 }


 #heatmap-countries-list {
     margin-top: 10em;
     overflow: auto;
     max-height: 20em;
     background-color: #27293D;
     /*border: 1px solid black;*/
     padding: 10px;
     border-radius: 5px;
 }
 #heatmap-countries-list a {
     text-transform: capitalize;
 }

 #map {
     /* border: 1px solid yellow; */
     /* part of resizing D3 svg: https://chartio.com/resources/tutorials/how-to-resize-an-svg-when-the-window-is-resized-in-d3-js/ */
     display: inline-block;
     position: relative;
     width: 100%;
     padding-bottom: 100%;
     vertical-align: top;
     overflow: hidden;
 }

 .svg-content {
     display: inline-block;
     position: absolute;
     max-height: 700px;
     top: 0;
     left: 0;
 }

 .legendLinear {
 }

 .legendTitle {
     fill:white;
 }
 .legendLinear text.label {
     fill:white;
 }

 div.heatmap_tooltip {
    position: absolute;
    text-align: left;
    padding: 5px;
    font: 12px sans-serif;
    font-weight: bold;

    color: white;
    background: black;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
    border: 1px solid grey ;
 }
</style>

<div class="row mb-3">
    <div class="col-2">
    </div>
    <div class="col-10 d-flex justify-content-center">
	<div>
	    
	    <div class="btn-group">
		<button type="button" class="btn btn-primary maptype" data-maptype="covid_rates">Covid-19 Cases</button>
		<button type="button" class="btn btn-secondary maptype" data-maptype="tx2019">2019 Transplants</button>
		<button type="button" class="btn btn-secondary maptype" data-maptype="tx2020">2020 Transplants</button>
	    </div>
	</div>
    </div>
</div> <!-- /.row - of the main container -->

<div class="row">
    <div class="col-2">
	<nav class="nav-pills" id="heatmap-countries-list">
	</nav>
    </div>

    <div class="col-10 d-flex justify-content-center">
	<div id="map">
	</div>
    </div>
</div> <!-- /.row - of the main container -->

        </div> <!-- /.container-fluid -->

        <!-- Footer -->
        <footer class="footer mt-auto py-3">
            <div class="container">
                <div class="row">
                    <div class="col-lg-6 h-100 text-center text-lg-left my-auto">
                        <p class="text-muted medium mb-4 mb-lg-0">
                            &copy; 2020
                            Paris Transplant Group
                        </p>
                    </div>
                    <div class="col-lg-6 h-100 text-center text-lg-right my-auto">
                        <ul class="list-inline mb-0">
                            <li class="list-inline-item mr-3">
                                <a href="https://twitter.com/ParisTxGroup">
                                    <i class="fab fa-twitter-square fa-2x fa-fw"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </footer>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
	
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
                integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
                crossorigin="anonymous"></script>

        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
                integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
                crossorigin="anonymous"></script>

        <!-- https://github.com/seiyria/bootstrap-slider
             https://seiyria.com/bootstrap-slider/#example-1 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>

        <script src="https://d3js.org/d3.v4.min.js"></script>

        <script src="/static/hierarchy-select/dist/hierarchy-select.min.js"></script>

        

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://d3js.org/queue.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v2.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>

<!-- https://cdnjs.com/libraries/d3-legend -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>

<script>

 var first_country = "france";
 var countries = ["argentina",
		  //"belgium",
		  "brazil",
		  "chile",
		  //"croatia",
		  //"finland",
		  "france",
		  "germany",
		  "italy",
		  //"portugal",
	          //"slovenia",
		  "spain",
		  //"UK",
		  "US"];


 var cname ;

 var width = 700,
     height = 500;

 var data ;

 var data_breaks;

 var svg = d3.select("#map").append("svg")
                 .attr("preserveAspectRatio", "xMinYMin meet")
		 .attr("viewBox", "0 0 " + width + " " + height)
	         .classed("svg-content",true);

 // Define the div for the tooltip
 var tooltip_div = d3.select("body").append("div")
                 .attr("class", "heatmap_tooltip")
                     .style("display","none")
                 .html("");

 var current_country_g;
 var legendLinear;

 var current_maptype;
 var current_color_mapper;
 var legend_title = "";
 var region_values = {};
 var legend_label_min = "min";
 var legend_label_max = "max";

 var legend_labels = [] ;

 function prepare_color_data()
 {
     /* prepare the color values based on the currently selected map type */
     // Convert to a dictionary of regions->values

     if (current_maptype == "covid_rates") {
         get_value = function(x){return +x.covid_norm;};
         //Interpolate colors from light-blue to dark-blue,
         //don't start at White, as White is used to indicate "no data".
         color_schema = d3.interpolateRgb("#A2CBE3","#08336F");
         legend_title = "Covid Rates";

         legend_labels = data_breaks.map(x=>+x["covid"]);

     } else if (current_maptype == "tx2019") {
         get_value = function(x){return +x.tx2019_norm;};
         color_schema = d3.interpolateRgb("#FDB170","#7F2704");
         legend_title = "2019 Transplants";
         legend_labels = data_breaks.map(x=>+x["tx2019"]);

     } else if (current_maptype == "tx2020") {
         get_value = function(x){return +x.tx2020_norm;};
         color_schema = d3.interpolateRgb("#FDB170","#7F2704");
         legend_title = "2020 Transplants";
         legend_labels = data_breaks.map(x=>+x["tx2020"]);

     } else {
         console.log("error: invalid maptype = ", maptype);
     }

     legend_labels.shift();
     legend_labels = legend_labels.map(x => x.toFixed(2));
     //console.log("Legend Labels = ", legend_labels);

     // Convert to a dictionary of regions->values
     region_values = {};
     legend_label_min = Infinity;
     legend_label_max = 0 ;
     data.forEach(function(x){
         var value = get_value(x);
         region_values[x.name] = value ;
         if (value>legend_label_max) { legend_label_max = value; }
         if (value<legend_label_min) { legend_label_min = value; }
     });

     current_color_mapper = d3.scaleSequential(color_schema).domain([0,1]);
 }

 function tooltip_value(x)
 {
     if ( (x === undefined) || (x === "-1") || ( +x === -1 )) {
         return "No data";
     }
     return +x;
 }

 var current_region_tooltip = "" ;
 function drawToolTip(x)
 {
     var name = x.properties.name ;
     if (name != current_region_tooltip) {
         //console.log("Draw tool tip, x = ", x);
         //console.log("tool tip: ", name);
         current_region_tooltip = name;

         var tooltip_text = name + "<br/>";


         var region_data = data.filter(x => x.name ==name);
         if (region_data.length==1) {
             region_data = region_data[0];

             tooltip_text += "Total COVID-19 cases: " + tooltip_value(region_data["covid_rate"]).toString() + "<br/>"
                           + "Total Transplants in 2019: " + tooltip_value(region_data["tx2019"]).toString() + "<br/>"
                           + "Total Transplants in 2020: " + tooltip_value(region_data["tx2020"]).toString() + "<br/>";
         } else {
             tooltip_text += "No data for this region";
         }


         tooltip_div
             .style('display', 'block')
             .style('left', (d3.event.pageX + 20) + "px")
             .style('top',  (d3.event.pageY - 20) + "px")
             .html(tooltip_text);

     }
 }

 function tooltip_hide2()
 {
     if (current_region_tooltip) {
         if (tooltip_div) tooltip_div.style('display', 'none');
         current_region_tooltip = "";
     }
 }

 function ready(error, topology, counts, breaks)
 {
     if (error) throw error;

     // global variable "data" will contain the TSV values,
     // as an array-of-dict.
     data = counts;

     data_breaks = breaks ;

     //console.log("topology = ", topology);
     //console.log("counts = ", counts);
     //console.log("breaks = ", breaks);

     var dd = Object.values(topology.objects)[0];

     if (current_country_g) {
     current_country_g.selectAll("path")
              .transition()
              .duration(500)
              .style('opacity',0)
              .remove();

     svg.selectAll(".legendLinear")
        .transition()
        .duration(500)
        .style('opacity',0)
        .remove();
     }

     var map_y_offset = 100 ;

     var geojson = topojson.feature(topology, dd);

     var projection = d3.geoMercator().fitSize([width, height-map_y_offset], geojson);
     var path = d3.geoPath().projection(projection);

     var dummy_center_projection = d3.geoMercator().fitExtent([[width/2,(height-map_y_offset)/2],
                                   [width/2,(height-map_y_offset)/2]],
                                  geojson);
     var dummy_center_path = d3.geoPath().projection(dummy_center_projection);

     var g = svg.append("g")
        .attr("transform", "translate(20," + map_y_offset.toString() + ")");
     current_country_g = g;

     g.on("mouseout",tooltip_hide2);


     prepare_color_data();

     /* from: https://d3-legend.susielu.com/#*/
     /* TODO: set cells to number of breaks */
     legendLinear = d3.legendColor()
              .shapeWidth(40)
              .cells(data_breaks.length-1)
              .orient('horizontal')
              .scale(current_color_mapper)
                      .title(legend_title)
                      .labels(legend_labels)
/*                      .labels(function(x){
                          if (x.i==0 ) {
                              return legend_label_min;
                          } else if (x.i == x.genLength-1) {
                              return legend_label_max;
                          } else {
                              return "";
                          }
                      })*/
              .labelFormat(d3.format(".2f"));

     var legend_g = svg.append("g")
    .attr("class", "legendLinear")
    .attr("transform", "translate(0,20)");

     legend_g.call(legendLinear);


     var rejoin = g.selectAll("path")
             .data(geojson.features) ;

     //Draw a PATH
     var things = rejoin.enter()
                        .append("path")
                        .attr("class","dataline")
                        .attr("d",dummy_center_path)
                        .style('opacity',0.5)
                        .on('mousemove', drawToolTip)
                        .merge(rejoin);


     things.transition()
           .duration(500)
           .style('opacity',1)
       .attr('d', path)
       .style("fill", function(region){
           var region_name = region.properties.name;
           var value = region_values[region_name];
           //console.log("region value = ", region_name, value);
           var clr = "#F0F";
           if ( (value == -1) || (value === undefined) ) {
               clr = "#FFF"; // No data - show in white
           } else {
               clr =  current_color_mapper(value);
           }
           return clr;
       })
       .style("stroke-width", "1")
           .style("stroke", "black");
 }

 function change_country_data()
 {
     prepare_color_data();

     if (current_country_g) {
	     legendLinear.scale(current_color_mapper)
                               .labels(legend_labels)
		     .title(legend_title);

	 svg.select(".legendLinear")
	    .call(legendLinear);


	 current_country_g.selectAll("path")
			  .transition()
			          .duration(500)
			          .style("fill", function(region){
                          var region_name = region.properties.name;
                          var value = region_values[region_name];
                          //console.log("region value = ", region_name, value);
                          var clr = "#F0F";
                          if ( (value == -1) || (value === undefined) ) {
                              clr = "#FFF"; // No data - show in white
                          } else {
                              clr =  current_color_mapper(value);
                          }
                          return clr;
			  })
         ;
     }
 }

 function load_country(name)
 {
     cname = name;
     queue()
	 .defer(d3.json, "/static/heatmap/" + cname + ".json" + "?" + Math.random().toString())
	 .defer(d3.tsv, "/static/heatmap/" + cname + ".tsv"+ "?" + Math.random().toString())
	 .defer(d3.tsv, "/static/heatmap/" + cname + "_breaks.tsv"+ "?" + Math.random().toString())
	 .await(ready);
 }

 function create_countries_list()
 {
     var l = $("#heatmap-countries-list");

     countries.forEach(function(x){
	 var s = (x==first_country)?"active":""
	 var p = l.append(`<a class="nav-link ${s}" country=button data-country="${x}" href="">${x}</a>`);
     });

     $("a[country='button']").click(function(e){
	 e.preventDefault();

	 var t = $(this);
	 var c = t.data("country");

	 //move the "active" class to the newly clicked link
	 $("a[country='button']").removeClass("active");
	 t.addClass("active");

	 load_country(c);

	 return false;
     });
 }

 function setup_maptype_buttons()
 {
     $("button.maptype").click(function(e){
	 e.preventDefault();
	 var t = $(this);
	 var maptype = t.data("maptype");

	 var other_buttons = $("button.maptype").not(this);

	 other_buttons.removeClass("btn-primary").addClass("btn-secondary");
	 $(this).addClass("btn-primary").removeClass("btn-secondary");

	 current_maptype = maptype;
	 change_country_data(maptype);
     });
 }


 $(function(){
     create_countries_list();

     setup_maptype_buttons();

     current_maptype = "covid_rates";
     load_country(first_country);
 });
</script>

    </body>
</html>